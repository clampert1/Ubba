<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UBBA DANCE BATTLE — FINAL FIXED</title>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: Arial, sans-serif;
  color: white;
  user-select: none;
}

#hud {
  position: absolute;
  top: 10px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 40px;
}

.health {
  width: 200px;
  height: 20px;
  background: #222;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}
.fill {
  height: 100%;
  background: limegreen;
  transition: width 0.2s;
}
.label {
  position: absolute;
  top: -22px;
  width: 100%;
  text-align: center;
  font-weight: bold;
}

#center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

#keys-top, #keys-top-ubba {
  position: absolute;
  top: 100px;
  display: flex;
  gap: 20px;
}

#keys-top {
  left: 20%;
}

#keys-top-ubba {
  right: 20%;
}

.key {
  width: 60px;
  height: 60px;
  border: 3px solid #444;
  border-radius: 8px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  background: #111;
  transition: background 0.1s, transform 0.1s;
}
.key.active {
  background: #0f0;
}
.key.miss {
  background: #f00;
}
.key.hit {
  background: #0f0;
}

#arrows {
  position: absolute;
  bottom: 100px;
  width: 100%;
  height: 500px;
  overflow: visible;
  pointer-events: none;
}

.arrow {
  position: absolute;
  font-size: 32px;
  opacity: 0.9;
  transition: transform 0.05s;
}

#player-avatar, #ubba-avatar {
  position: absolute;
  bottom: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
#player-avatar { left: 20%; }
#ubba-avatar { right: 20%; }

.avatar-box {
  width: 120px;
  height: 120px;
  background: #333;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 10px;
  color: white;
  font-weight: bold;
}
</style>
</head>
<body>
  <div id="hud">
    <div class="health" id="playerHealth">
      <div class="fill" id="playerFill"></div>
      <div class="label">PLAYER</div>
    </div>
    <div class="health" id="ubbaHealth">
      <div class="fill" id="ubbaFill"></div>
      <div class="label">UBBA</div>
    </div>
  </div>

  <div id="keys-top">
    <div class="key" id="keyA">A</div>
    <div class="key" id="keyS">S</div>
    <div class="key" id="keyW">W</div>
    <div class="key" id="keyD">D</div>
  </div>

  <div id="keys-top-ubba">
    <div class="key" id="keyLeft">←</div>
    <div class="key" id="keyDown">↓</div>
    <div class="key" id="keyUp">↑</div>
    <div class="key" id="keyRight">→</div>
  </div>

  <div id="center">
    <div id="score">SCORE: 0</div>
    <div id="level">LEVEL 1</div>
  </div>

  <div id="arrows"></div>

  <div id="player-avatar">
    <div class="avatar-box">YOU</div>
  </div>

  <div id="ubba-avatar">
    <div class="avatar-box">UBBA</div>
  </div>

<script>
const CONFIG = {
  baseSpeed: 3.0,
  spawnGapBase: 700,
  hitTolerance: 60,
  hpLoss: 1,
  hpGain: 1,
  maxHP: 12,
  rounds: 3
};

const state = {
  playing: true,
  playerHP: CONFIG.maxHP,
  ubbaHP: CONFIG.maxHP,
  arrows: [],
  isBotTurn: false,
  score: 0,
  level: 1
};

const keys = {
  A: document.getElementById("keyA"),
  S: document.getElementById("keyS"),
  W: document.getElementById("keyW"),
  D: document.getElementById("keyD"),
  ArrowLeft: document.getElementById("keyLeft"),
  ArrowDown: document.getElementById("keyDown"),
  ArrowUp: document.getElementById("keyUp"),
  ArrowRight: document.getElementById("keyRight")
};

const playerFill = document.getElementById("playerFill");
const ubbaFill = document.getElementById("ubbaFill");
const arrowsContainer = document.getElementById("arrows");
const scoreEl = document.getElementById("score");
const levelEl = document.getElementById("level");

const directions = ["A", "S", "W", "D"];
const botDirections = ["ArrowLeft", "ArrowDown", "ArrowUp", "ArrowRight"];

function updateHUD() {
  playerFill.style.width = (state.playerHP / CONFIG.maxHP * 100) + "%";
  ubbaFill.style.width = (state.ubbaHP / CONFIG.maxHP * 100) + "%";
  scoreEl.textContent = `SCORE: ${state.score}`;
  levelEl.textContent = `LEVEL ${state.level}`;
}

function flashKey(key, result) {
  if (!keys[key]) return;
  keys[key].classList.add(result);
  setTimeout(() => keys[key].classList.remove(result), 150);
}

function spawnArrow(side, key) {
  const el = document.createElement("div");
  el.className = "arrow";
  el.textContent = getArrowSymbol(key);
  el.style.left = side === "player"
    ? (["A","S","W","D"].indexOf(key) * 80 + 250) + "px"
    : (["ArrowLeft","ArrowDown","ArrowUp","ArrowRight"].indexOf(key) * 80 + window.innerWidth - 550) + "px";
  el.style.bottom = "0px";
  el.style.color = side === "player" ? "#6ff" : "#f66";
  arrowsContainer.appendChild(el);

  state.arrows.push({ el, key, side, y: 0, hit: false });
}

function getArrowSymbol(k) {
  switch (k) {
    case "A": case "ArrowLeft": return "←";
    case "S": case "ArrowDown": return "↓";
    case "W": case "ArrowUp": return "↑";
    case "D": case "ArrowRight": return "→";
  }
  return "";
}

function hitTest(key) {
  let success = false;
  for (let i = 0; i < state.arrows.length; i++) {
    const a = state.arrows[i];
    if (a.key === key && a.side === "player" && !a.hit) {
      const dist = Math.abs(a.y - 450);
      if (dist < CONFIG.hitTolerance) {
        a.hit = true;
        success = true;
        state.score += 100;
        flashKey(key, "hit");
        a.el.remove();
        break;
      }
    }
  }

  if (!success) {
    flashKey(key, "miss");
    state.playerHP = Math.max(0, state.playerHP - CONFIG.hpLoss);
  }

  updateHUD();
}

document.addEventListener("keydown", (e) => {
  if (["A","S","W","D"].includes(e.key)) hitTest(e.key);
});

function loop() {
  for (let i = state.arrows.length - 1; i >= 0; i--) {
    const a = state.arrows[i];
    a.y += CONFIG.baseSpeed;
    a.el.style.bottom = a.y + "px";
    if (a.y > 600 && !a.hit) {
      if (a.side === "player") {
        a.hit = true;
        flashKey(a.key, "miss");
        state.playerHP = Math.max(0, state.playerHP - CONFIG.hpLoss);
        updateHUD();
      }
      a.el.remove();
      state.arrows.splice(i, 1);
    }
  }

  requestAnimationFrame(loop);
}

function botTurn() {
  state.isBotTurn = true;
  let seq = [];
  let count = state.level === 3 ? 35 : (state.level === 2 ? 20 : 10);

  for (let i = 0; i < count; i++) {
    const keysNum = state.level === 3 && Math.random() < 0.3 ? 2 + Math.floor(Math.random() * 2) : 1;
    const chord = [];
    for (let j = 0; j < keysNum; j++) {
      chord.push(botDirections[Math.floor(Math.random() * botDirections.length)]);
    }
    seq.push(chord);
  }

  let delay = 0;
  seq.forEach(chord => {
    setTimeout(() => {
      chord.forEach(k => {
        spawnArrow("ubba", k);
        flashKey(k, "hit");
      });
    }, delay);
    delay += CONFIG.spawnGapBase / (state.level === 3 ? 1.7 : 1);
  });

  setTimeout(() => {
    state.isBotTurn = false;
    playerTurn();
  }, delay + 2000);
}

function playerTurn() {
  state.level++;
  if (state.level > CONFIG.rounds) {
    endGame();
    return;
  }
  updateHUD();
  generatePlayerArrows();
}

function generatePlayerArrows() {
  let count = state.level === 3 ? 35 : (state.level === 2 ? 20 : 10);
  let delay = 0;
  for (let i = 0; i < count; i++) {
    const k = directions[Math.floor(Math.random() * directions.length)];
    setTimeout(() => spawnArrow("player", k), delay);
    delay += CONFIG.spawnGapBase / (state.level === 3 ? 1.7 : 1);
  }

  // softlock prevention: detect when sequence done
  setTimeout(() => {
    if (state.arrows.every(a => a.side !== "player" || a.hit)) {
      botTurn();
    }
  }, delay + 4000);
}

function endGame() {
  alert(state.playerHP > state.ubbaHP ? "YOU WIN!" : "UBBA WINS!");
  state.playing = false;
}

updateHUD();
botTurn();
loop();
</script>
</body>
</html>
