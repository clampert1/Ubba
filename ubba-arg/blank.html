<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UBBA DANCE BATTLE — Fixed Expert</title>
<style>
/* Minimal essential styles */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
#game{position:relative;width:100vw;height:100vh}
#background{position:absolute;inset:0;background:url('https://raw.githubusercontent.com/clampert1/Ubba/main/ubba-arg/assets/cameras/office.png') center/cover no-repeat;filter:brightness(.34);z-index:0}

/* HUD & health */
#hud{position:absolute;top:16px;left:50%;transform:translateX(-50%);width:88%;max-width:1320px;display:flex;justify-content:space-between;align-items:center;z-index:70}
.health{width:380px;height:34px;background:#222;border:3px solid #fff;border-radius:6px;overflow:hidden;position:relative}
.fill{position:absolute;top:0;left:0;height:100%;background:#0f0;width:100%;transition:width .25s}
#ubbaFill{background:#ff3b3b;left:auto;right:0}
.label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;text-shadow:1px 1px 3px #000}

/* Top controls (keep wide spacing to left/right) */
#top-controls{position:absolute;top:72px;left:50%;transform:translateX(-50%);width:100%;max-width:1320px;display:flex;justify-content:space-between;align-items:flex-start;gap:20px;padding:0 28px;z-index:80}
.lane-side{display:flex;gap:18px;align-items:flex-start}
.arrow-target{width:86px;height:86px;background:rgba(0,0,0,.55);border-radius:10px;border:4px solid #222;display:flex;align-items:center;justify-content:center;position:relative}
.static{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);width:70px;height:70px;border-radius:8px;background:#222;color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:22px;border:3px solid}
.static.left{border-color:#4ecdc4}
.static.down{border-color:#ffe66d}
.static.up{border-color:#ff6b6b}
.static.right{border-color:#ff9f1c}
.static.active{background:#0f0;color:#000;transform:translateX(-50%) scale(1.06);box-shadow:0 0 18px rgba(0,255,0,.6)}
.static.miss{background:#ff0000;color:#fff;transform:translateX(-50%) scale(1.06);box-shadow:0 0 18px rgba(255,0,0,.6)}

/* characters bottom */
#characters{position:absolute;left:50%;transform:translateX(-50%);bottom:50px;display:flex;justify-content:space-between;width:95%;max-width:1320px;padding:0 28px;z-index:70}
.char{width:200px;height:200px;border-radius:10px;border:4px solid #fff;display:flex;align-items:center;justify-content:center;font-size:22px}
#ubbaChar{background:#000 url('https://raw.githubusercontent.com/clampert1/Ubba/main/ubba-arg/assets/sprites/ubba.png') center/contain no-repeat}

/* arrows */
#arrows{position:absolute;inset:0;pointer-events:none;z-index:75}
.arrow{position:absolute;width:70px;height:70px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;color:#fff;border:3px solid}
.arrow.left{background:#4ecdc4;border-color:#4ecdc4}
.arrow.down{background:#ffe66d;border-color:#ffe66d;color:#000}
.arrow.up{background:#ff6b6b;border-color:#ff6b6b}
.arrow.right{background:#ff9f1c;border-color:#ff9f1c}

/* HUD text */
#score{position:absolute;top:118px;left:50%;transform:translateX(-50%);font-size:22px;color:#dfe;text-shadow:1px 1px 3px #000;z-index:80}
#combo{position:absolute;top:154px;left:50%;transform:translateX(-50%);font-size:18px;color:#8ff;display:none;z-index:80}
#level{position:absolute;top:182px;left:50%;transform:translateX(-50%);font-size:20px;color:#fff;z-index:80}
#botTurn{position:absolute;top:210px;left:50%;transform:translateX(-50%);font-size:28px;color:#ffd700;display:none;z-index:80}

/* overlays */
#start,#results{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.8);z-index:140}
#results{display:none}
.btn{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff;padding:12px 22px;border-radius:10px;border:3px solid #fff;cursor:pointer;font-size:18px;margin-top:12px}

/* effects */
.hit,.miss{position:absolute;width:80px;height:80px;border-radius:50%;pointer-events:none;z-index:150;animation:eff .35s forwards}
.hit{background:rgba(0,255,0,.42)}
.miss{background:rgba(255,0,0,.42)}
@keyframes eff{from{transform:scale(.6);opacity:1}to{transform:scale(2);opacity:0}}
@media(max-width:900px){.arrow-target{width:70px;height:70px}.static{width:56px;height:56px;font-size:18px}}
</style>
</head>
<body>
<div id="game">
  <div id="background"></div>

  <div id="hud">
    <div class="health" id="player"><div class="fill" id="playerFill" style="width:100%"></div><div class="label">PLAYER</div></div>
    <div class="health" id="ubba"><div class="fill" id="ubbaFill" style="width:100%"></div><div class="label">UBBA</div></div>
  </div>

  <div id="top-controls">
    <div class="lane-side" id="player-side">
      <div class="arrow-target"><div class="static left" data-key="a">A</div></div>
      <div class="arrow-target"><div class="static down" data-key="s">S</div></div>
      <div class="arrow-target"><div class="static up" data-key="w">W</div></div>
      <div class="arrow-target"><div class="static right" data-key="d">D</div></div>
    </div>

    <div class="lane-side" id="ubba-side">
      <div class="arrow-target"><div class="static left" data-key="ArrowLeft">←</div></div>
      <div class="arrow-target"><div class="static down" data-key="ArrowDown">↓</div></div>
      <div class="arrow-target"><div class="static up" data-key="ArrowUp">↑</div></div>
      <div class="arrow-target"><div class="static right" data-key="ArrowRight">→</div></div>
    </div>
  </div>

  <div id="score">SCORE: 0</div>
  <div id="combo">COMBO: 0</div>
  <div id="level">LEVEL 1</div>
  <div id="botTurn">UBBA'S TURN</div>

  <div id="characters">
    <div class="char" id="you">YOU</div>
    <div class="char" id="ubbaChar"></div>
  </div>

  <div id="arrows"></div>

  <div id="start">
    <h1 style="margin-bottom:8px;color:#ff6b6b">UBBA DANCE BATTLE</h1>
    <p style="margin-bottom:14px">Watch Ubba then repeat — keys A S W D. Round 3 is expert with chords.</p>
    <button class="btn" id="startBtn">START BATTLE</button>
  </div>

  <div id="results">
    <h1 id="resultTitle">BATTLE COMPLETE</h1>
    <div id="resultText" style="margin-top:6px"></div>
    <button class="btn" id="replay">PLAY AGAIN</button>
  </div>
</div>

<script>
/* REPLACE your existing <script> block with this fixed one — everything else unchanged */

const CONFIG = { baseSpeed: 3.2, spawnGapBase: 600, hitTolerance: 56, hpGain: 2, hpLoss: 1, rounds: 3, chordWindow: 220 };
const state = { playing:false, round:1, score:0, combo:0, maxCombo:0, playerHP:100, ubbaHP:100, arrows:[], sequence:[], isBotPhase:true, ubbaTimers:[], recentKeyPresses:[], lastFrameTime:performance.now() };
const els = {
  start:document.getElementById('start'), startBtn:document.getElementById('startBtn'),
  results:document.getElementById('results'), resultTitle:document.getElementById('resultTitle'),
  resultText:document.getElementById('resultText'), replay:document.getElementById('replay'),
  score:document.getElementById('score'), combo:document.getElementById('combo'),
  level:document.getElementById('level'), botTurn:document.getElementById('botTurn'),
  arrows:document.getElementById('arrows'), playerSide:document.getElementById('player-side'),
  ubbaSide:document.getElementById('ubba-side'), playerFill:document.getElementById('playerFill'), ubbaFill:document.getElementById('ubbaFill')
};
const KEY_MAP = { a:'left', s:'down', w:'up', d:'right' };
const ARROW_SYMBOL = { left:'←', down:'↓', up:'↑', right:'→' };

function computeTargets(){
  const map={player:{},ubba:{}};
  document.querySelectorAll('#player-side .static').forEach(s=>{
    if(s.classList.contains('left'))map.player.left=s.getBoundingClientRect();
    if(s.classList.contains('down'))map.player.down=s.getBoundingClientRect();
    if(s.classList.contains('up'))map.player.up=s.getBoundingClientRect();
    if(s.classList.contains('right'))map.player.right=s.getBoundingClientRect();
  });
  document.querySelectorAll('#ubba-side .static').forEach(s=>{
    if(s.classList.contains('left'))map.ubba.left=s.getBoundingClientRect();
    if(s.classList.contains('down'))map.ubba.down=s.getBoundingClientRect();
    if(s.classList.contains('up'))map.ubba.up=s.getBoundingClientRect();
    if(s.classList.contains('right'))map.ubba.right=s.getBoundingClientRect();
  });
  return map;
}
function makeSequence(r){const b=['left','down','up','right'];if(r<3){const l=6+(r-1)*4;return Array.from({length:l},()=>b[Math.floor(Math.random()*b.length)])}else{const c=[['up','right'],['left','up'],['down','right'],['left','down','up'],['right','up','left']];const l=22,s=[];for(let i=0;i<l;i++){if(Math.random()<.28)s.push(c[Math.floor(Math.random()*c.length)]);else s.push(b[Math.floor(Math.random()*b.length)])}return s}}
function spawnArrow(type,side,gid=null){
  const tr=computeTargets();const sr=side==='player'?tr.player[type]:tr.ubba[type];if(!sr)return;
  const a=document.createElement('div');a.className=`arrow ${type}`;a.textContent=ARROW_SYMBOL[type];
  const left=Math.round(sr.left+sr.width/2-35);a.style.left=left+'px';
  const cr=document.getElementById('characters').getBoundingClientRect();const sb=Math.max(20,window.innerHeight-cr.top+12);a.style.bottom=sb+'px';
  els.arrows.appendChild(a);
  const obj={el:a,type,side,y:sb,hit:false,spawnTime:performance.now(),groupId:gid};state.arrows.push(obj);
  if(side==='ubba')scheduleUbbaForArrow(obj,sr);return obj;
}
function scheduleUbbaForArrow(o,sr){
  const ar=o.el.getBoundingClientRect(),ac=ar.top+ar.height/2,sc=sr.top+sr.height/2,d=ac-sc;
  const pxPerMs=currentSpeed()/(1000/60),t=Math.max(0,d/pxPerMs);
  const pre=70;const ft=setTimeout(()=>flashStatic('ubba',o.type,110),Math.max(0,t-pre));
  const ht=setTimeout(()=>{if(!o.hit){if(o.groupId!==null){const g=state.arrows.filter(a=>a.groupId===o.groupId);g.forEach(x=>{x.hit=true;if(x.el&&x.el.parentElement)x.el.remove()});state.arrows=state.arrows.filter(a=>a.groupId!==o.groupId)}else{o.hit=true;if(o.el&&o.el.parentElement)o.el.remove();state.arrows=state.arrows.filter(a=>a!==o)}}},Math.max(0,t+12));
  state.ubbaTimers.push(ft,ht);
}
function flashStatic(s,t,ms=140){const c=s==='player'?els.playerSide:els.ubbaSide;const e=[...c.querySelectorAll('.static')].find(x=>x.classList.contains(t));if(!e)return;e.classList.add('active');setTimeout(()=>e.classList.remove('active'),ms);}
function flashStaticMiss(s,t,ms=140){
  const c=s==='player'?els.playerSide:els.ubbaSide;
  const e=[...c.querySelectorAll('.static')].find(x=>x.classList.contains(t));
  if(!e)return;
  // align red flash correctly to static
  const rect=e.getBoundingClientRect();
  const eff=document.createElement('div');
  eff.className='miss'; eff.style.left=(rect.left+rect.width/2-40)+'px'; eff.style.top=(rect.top+rect.height/2-40)+'px';
  document.body.appendChild(eff);
  setTimeout(()=>eff.remove(),360);
  e.classList.add('miss'); setTimeout(()=>e.classList.remove('miss'),ms);
}
function currentSpeed(){return CONFIG.baseSpeed*(state.round===3?2.0:1.0);}
function spawnPlayerSequence(seq){let i=0;const g=state.round===3?350:CONFIG.spawnGapBase;const id=(()=>{let id=0;return()=>++id})();const t=setInterval(()=>{if(i>=seq.length){clearInterval(t);return;}const s=seq[i];if(Array.isArray(s)){const gid=id();s.forEach(x=>spawnArrow(x,'player',gid))}else spawnArrow(s,'player',null);i++;},g);}
function showUbbaSequence(seq,cb){state.isBotPhase=true;els.botTurn.style.display='block';cleanupRoundPrep();let i=0;const g=state.round===3?350:CONFIG.spawnGapBase;const id=(()=>{let id=0;return()=>++id})();const t=setInterval(()=>{if(i>=seq.length){clearInterval(t);setTimeout(()=>{state.isBotPhase=false;els.botTurn.style.display='none';cb();},500);return;}const s=seq[i];if(Array.isArray(s)){const gid=id();s.forEach(x=>spawnArrow(x,'ubba',gid))}else spawnArrow(s,'ubba',null);i++;},g);}
function loop(ct){if(!state.playing)return;const dt=ct-state.lastFrameTime;state.lastFrameTime=ct;
  for(let i=state.arrows.length-1;i>=0;i--){const a=state.arrows[i];if(a.hit){state.arrows.splice(i,1);continue;}
    const fs=currentSpeed()*(dt/(1000/60));a.y+=fs;a.el.style.bottom=a.y+'px';const r=a.el.getBoundingClientRect();
    if(r.bottom<0){if(a.side==='player'&&!a.hit){a.hit=true;state.playerHP=Math.max(0,state.playerHP-CONFIG.hpLoss);state.combo=0;showEffect(a.el,'miss');flashStaticMiss('player',a.type,150);updateHUD();}
      if(a.el&&a.el.parentElement)a.el.remove();state.arrows.splice(i,1);}
  }
  // check lose mid-loop
  if(state.playerHP<=0){finishGame();return;}
  requestAnimationFrame(loop);
}
function showEffect(el,cls){try{const r=el.getBoundingClientRect();const e=document.createElement('div');e.className=cls==='hit'?'hit':'miss';e.style.left=(r.left+r.width/2-40)+'px';e.style.top=(r.top+r.height/2-40)+'px';document.body.appendChild(e);setTimeout(()=>e.remove(),360);}catch(e){}}
document.addEventListener('keydown',ev=>{if(!state.playing||state.isBotPhase)return;const k=ev.key.toLowerCase();if(!(k in KEY_MAP))return;const n=performance.now();state.recentKeyPresses.push({type:KEY_MAP[k],time:n});while(state.recentKeyPresses.length&&n-state.recentKeyPresses[0].time>CONFIG.chordWindow)state.recentKeyPresses.shift();attemptHit(KEY_MAP[k]);});
function attemptHit(pt){
  const t=computeTargets().player,n=performance.now();const c=state.arrows.filter(a=>a.side==='player'&&!a.hit);
  if(!c.length){flashStaticMiss('player',pt,150);state.playerHP=Math.max(0,state.playerHP-CONFIG.hpLoss);state.combo=0;updateHUD();checkRoundCompletion();return;}
  const near=[];for(const a of c){const r=a.el.getBoundingClientRect();const ay=r.top+r.height/2;const sy=t[a.type].top+t[a.type].height/2;if(Math.abs(ay-sy)<=CONFIG.hitTolerance)near.push(a);}
  if(!near.length){flashStaticMiss('player',pt,150);state.playerHP=Math.max(0,state.playerHP-CONFIG.hpLoss);state.combo=0;updateHUD();checkRoundCompletion();return;}
  const g={};for(const a of near){const r=a.el.getBoundingClientRect();const cY=Math.round(r.top+r.height/2);const k=Math.round(cY/8)*8;g[k]=g[k]||[];g[k].push(a);}
  let cg=null;for(const k in g){const gg=g[k];if(gg.some(x=>x.type===pt)){cg=gg;break;}}if(!cg){const ks=Object.keys(g);cg=g[ks[0]];}
  const req=[...new Set(cg.map(a=>a.type))];const ps=new Set(state.recentKeyPresses.map(p=>p.type));const all=req.every(r=>ps.has(r));
  if(all){cg.forEach(a=>{a.hit=true;showEffect(a.el,'hit');flashStatic('player',a.type,150);if(a.el&&a.el.parentElement)a.el.remove();});state.arrows=state.arrows.filter(a=>!a.hit);state.score+=100*Math.max(1,req.length);state.combo+=1;state.maxCombo=Math.max(state.maxCombo,state.combo);state.playerHP=Math.min(100,state.playerHP+CONFIG.hpGain);state.ubbaHP=Math.max(0,state.ubbaHP-CONFIG.hpLoss*req.length);updateHUD();}
  else{flashStaticMiss('player',pt,150);state.playerHP=Math.max(0,state.playerHP-CONFIG.hpLoss);state.combo=0;updateHUD();}
  checkRoundCompletion();
}
function checkRoundCompletion(){
  const exist=state.arrows.some(a=>a.side==='player'&&!a.hit);
  if(!state.isBotPhase&&!exist){
    if(state.playerHP<=0||state.ubbaHP<=0||state.round>=CONFIG.rounds){finishGame();}
    else{state.round++;setTimeout(()=>{updateHUD();startRound();},900);}
  }
}
function cleanupRoundPrep(){state.ubbaTimers.forEach(t=>clearTimeout(t));state.ubbaTimers=[];state.arrows.forEach(a=>{try{a.el.remove()}catch(e){}});state.arrows=[];state.recentKeyPresses=[];}
function startRound(){state.sequence=makeSequence(state.round);state.isBotPhase=true;els.botTurn.style.display='block';cleanupRoundPrep();showUbbaSequence(state.sequence,()=>{spawnPlayerSequence(state.sequence)});}
function finishGame(){
  state.playing=false;cleanupRoundPrep();
  els.results.style.display='flex';els.start.style.display='none';
  const vic=(state.ubbaHP<=0&&state.playerHP>0)||(state.score>=800);
  els.resultTitle.textContent=vic?'VICTORY!':(state.playerHP<=0?'YOU LOST! TRY AGAIN?':'DEFEAT!');
  els.resultTitle.style.color=vic?'#1df53a':'#ff4b4b';
  els.resultText.innerHTML=`SCORE: ${state.score} • MAX COMBO: ${state.maxCombo}`;
}
function updateHUD(){
  els.score.textContent=`SCORE: ${state.score}`;
  els.combo.style.display=state.combo>1?'block':'none';
  els.combo.textContent=`COMBO: ${state.combo}`;
  els.level.textContent=`LEVEL ${state.round}`;
  els.playerFill.style.width=`${state.playerHP}%`;
  els.ubbaFill.style.width=`${state.ubbaHP}%`;
  if(state.playerHP<=0){finishGame();}
}
function startGame(){state.playing=true;state.round=1;state.score=0;state.combo=0;state.maxCombo=0;state.playerHP=100;state.ubbaHP=100;state.lastFrameTime=performance.now();updateHUD();els.start.style.display='none';els.results.style.display='none';startRound();requestAnimationFrame(loop);}
document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('replay').addEventListener('click',()=>location.reload());
document.querySelectorAll('.static.down').forEach(s=>s.style.color='#fff');
window.addEventListener('resize',()=>{});
</script>

</body>
</html>
